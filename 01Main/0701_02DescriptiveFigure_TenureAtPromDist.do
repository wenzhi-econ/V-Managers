/* 
This do file constructs the distribution of age at promotion (to WL2).

RA: WWZ 
Time: 2024-12-09
*/

*??*??*??*??*??*??*??*??*??*??*??*??*??*??*??*??*??*??*??*??*??*??*??*??*??
*?? step 1. the age-at-promotion profile
*??*??*??*??*??*??*??*??*??*??*??*??*??*??*??*??*??*??*??*??*??*??*??*??*??

*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?
*-? s-1-1. a complete list of managers
*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?

use "${TempData}/04MainOutcomesInEventStudies.dta", clear
tempfile Mngr_List
keep IDlseMHR
duplicates drop 
save `Mngr_List'

*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?
*-? s-1-2. keep only those WL2 employees in the list 
*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?

use "${TempData}/04MainOutcomesInEventStudies.dta", clear

generate WL2 = (WL==2) if WL!=.
sort IDlse YearMonth
bysort IDlse: egen Ever_WL2 = max(WL2)

keep if Ever_WL2==1
    //&? First, keep a panel of employees who have ever been WL2 (full history).

drop IDlseMHR
generate  IDlseMHR=IDlse
merge m:1 IDlseMHR using `Mngr_List'
keep if _merge==3 
    //&? Second, keep only those WL2 employees who have ever been managers.

preserve
    //impt: Apply the tenure restriction when creating this plot.

    *-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?
    *-? s-1-3. create relevant variables  
    *-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?

    sort IDlse YearMonth
    bysort IDlse: egen minAge = min(cond(WL==2 & Tenure<10, AgeBand, .))
    keep if minAge!=. 

    egen Ind_tag = tag(IDlse) 
    keep if Ind_tag==1
        //&? keep a cross-section of WL2 managers.

    egen total_counts = total(Ind_tag)
    bysort minAge: egen size = total(Ind_tag)
    replace size = size/total_counts
    separate size, by(minAge==1)

    *-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?
    *-? s-1-4. create the plot
    *-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?

    graph ///
        bar size0 size1 if minAge<5 ///
        , over(minAge) ///
        bar(1, bfcolor("237 68 74")) ///
        bar(2, bfcolor("145 179 215")) ///
        nofill legend(off) ylabel(0(0.1)0.6) ///
        title("Age at promotion to work-level 2")    

    graph export "${Results}/AgeWL2FT.pdf", replace as(pdf)

restore 


preserve
    //impt: Apply the tenure restriction when creating this plot.

    *-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?
    *-? s-1-3. create relevant variables  
    *-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?

    sort IDlse YearMonth
    bysort IDlse: egen minAge = min(cond(WL==2, AgeBand, .))
    keep if minAge!=. 

    egen Ind_tag = tag(IDlse) 
    keep if Ind_tag==1
        //&? keep a cross-section of WL2 managers.

    egen total_counts = total(Ind_tag)
    bysort minAge: egen size = total(Ind_tag)
    replace size = size/total_counts
    separate size, by(minAge==1)

    *-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?
    *-? s-1-4. create the plot
    *-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?*-?

    graph ///
        bar size0 size1 if minAge<5 ///
        , over(minAge) ///
        bar(1, bfcolor("237 68 74")) ///
        bar(2, bfcolor("145 179 215")) ///
        nofill legend(off) ylabel(0(0.1)0.6) ///
        title("Age at promotion to work-level 2")    

    graph export "${Results}/AgeWL2FT_NoTenureRestriction.pdf", replace as(pdf)

restore 